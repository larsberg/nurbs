function i(i){return!!i&&(!!i.dtype&&new RegExp("function View[0-9]+d(:?"+i.dtype+")+").test(String(i.constructor)))}function e(i){return!!i&&(void 0!==i.data&&Array.isArray(i.shape)&&void 0!==i.offset&&void 0!==i.stride)}function n(i){return Array.isArray(i)||ArrayBuffer.isView(i)}function t(r){if(r){if(i(r)||e(r))return"generic"===r.dtype?t.GENERIC_NDARRAY:t.NDARRAY;if(n(r))return t.ARRAY_OF_ARRAYS;throw new Error("Unhandled data type. Got type: "+typeof r)}}t.ARRAY_OF_ARRAYS="Arr",t.NDARRAY="Nd",t.GENERIC_NDARRAY="GenNd",t.PACKED="PackArr";var r=function i(e,n){return function(n,t){void 0===n||Array.isArray(n)||(n=[n]);for(var r=[],s=0;s<n.length;s++)r.push(i.sum(n[s]));if(t)for(n=0;n<r.length;n++)void 0!==t[n]&&(r[n]="("+r[n]+" + "+t[n]+") % "+t[n]);return e+r.join("_")}};function s(i){return function(e,n){void 0===e||Array.isArray(e)||(e=[e]);for(var t=[],s=0;s<e.length;s++)t.push(r.sum(e[s]));if(n)for(e=0;e<t.length;e++)void 0!==n[e]&&(t[e]="("+t[e]+" + "+n[e]+") % "+n[e]);return i(t)}}function o(i,e){var n;if(e)switch(t(e)){case t.ARRAY_OF_ARRAYS:return s((function(e){return i+"["+e.join("][")+"]"}));case t.GENERIC_NDARRAY:return s((function(e){return i+".get("+e.join(",")+")"}));case t.NDARRAY:return s((function(e){var t=[i+"Offset"];for(n=0;n<e.length;n++)t.push(i+"Stride"+n+" * ("+e[n]+")");return i+"["+t.join(" + ")+"]"}));case t.PACKED:default:return}}r.sum=function(i){return 0===(i=(i=Array.isArray(i)?i:[i]).filter((function(i){return void 0!==i&&0!==i}))).length&&i.push(0),i.join(" + ")};var a=[],h=[];function u(i,e,n){if(1!==e)throw new Error("Numerical derivative not implemented for order n = "+e+".");var t,r=void 0===arguments[this.splineDimension+3]?1e-4:arguments[this.splineDimension+3];for(a.length=this.splineDimension,t=0;t<this.splineDimension;t++)a[t+1]=arguments[t+3];var s,o,u,f=this.domain,d=f[n][0],c=f[n][1],l=a[n+1],p=(c-d)*r;for("closed"===this.boundary[n]?(s=d+(l-d-p+(u=c-d))%u,o=d+(l-d+p+u)%u,p*=2):(s=Math.min(c,Math.max(d,l-p)),p=(o=Math.min(c,Math.max(d,l+p)))-s),a[n+1]=s,a[0]=h,this.evaluate.apply(null,a),a[n+1]=o,a[0]=i,this.evaluate.apply(null,a),t=0;t<this.dimension;t++)i[t]=(i[t]-h[t])/p;return i}function f(i,e){for(var n=1,t=0,r=[];t<i.length;t++)n*=Array.isArray(i[t])?i[t][1]-i[t][0]:i[t],r[t]=Array.isArray(i[t])?i[t][0]:0;for(var s=0;s<n;s++)for(e(r.slice()),t=i.length-1;t>=0;t--){if(r[t]!==(Array.isArray(i[t])?i[t][1]:i[t])-1){r[t]++;break}r[t]=Array.isArray(i[t])?i[t][0]:0}}function d(i,e,n,r){var s,o=[];switch(t(r)){case t.NDARRAY:for(o.push("  var "+e+" = "+n+".data;"),o.push("  var "+e+"Offset = "+n+".offset;"),s=0;s<r.dimension;s++)o.push("  var "+e+"Stride"+s+" = "+n+".stride["+s+"];");break;case t.ARRAY_OF_ARRAYS:o.push("  var "+e+" = "+n+";")}return o.join("\n")}function c(i,n,t){if(i){if(e(i))return n+".shape["+t+"]";for(var r=n,s=0;s<t;s++)r+="[0]";return r+".length"}return"this.size["+t+"]"}var l={},p={};function v(i,e,s,o,a,h,u){var v,g,m,b,A,y,w=e.splineDimension,R=e.points,k=e.degree,D=e.weights,j=void 0!==D,E=e.knots,_=e.dimension,z=e.boundary;if(null!=u){Array.isArray(u)||(u=[u]);var Y=0;for(v=0;v<w;v++)void 0===u[v]&&(u[v]=0),Y+=u[v];if(j&&Y>1)throw new Error("Analytical derivative not implemented for rational b-splines with order n = "+Y+".")}h&&(i="Basis"+i),u&&(i="Der"+u.join("_")+"_"+i);var N=l[i];if(o)var x="function"==typeof o?o:console.log;if(N)return o&&x(p[i]),N.bind(e);var O=[],B="evaluate"+i,S=s.point;h&&(S=function(i,e){for(var n=[],t=0;t<i.length;t++){for(var r=i[t],s=[],o=0;o<r.length;o++)0!==r[o]&&s.push(r[o]);r=s.join(" + "),e[t]&&(r="("+r+" + "+e[t]+") % "+e[t]),n.push(r+" === "+I(t))}return"(("+n.join(" && ")+") ? 1 : 0)"});var F=s.weight,P=s.knot,C=r("k"),K=r("x"),G=r("w"),I=r("i"),M=r("t"),U=o?"domain":"d",V=r(o?"size":"s"),W=r(o?"knotIndex":"j"),q=!0;for(A=0;A<w;A++)n(E)&&n(E[A])&&(q=!1);function H(i){O.push("  "+(i||""))}function J(i){o&&H(i)}if(h)var L=[];var Q=[];for(v=0;v<w;v++)h&&L.push(I([v])),Q.push(M([v]));for(O.push("function "+B+" ("+(h?"":"out, ")+Q.join(", ")+(h?", "+L.join(", "):"")+") {"),H("var h, m, a, b;"),a&&(H("var "+U+" = this.domain;"),H("for (var i = 0; i < this.splineDimension; i++) {"),H("  a = arguments[i + 1];"),H("  if (a < "+U+"[i][0] || a > "+U+"[i][1] || a === undefined || isNaN(a)) {"),H("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+U+"[i][0]+', '+"+U+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),H("  }"),H("}")),A=0;A<w;A++)H("var "+V(A)+" = "+c(R,"this.points",A)+";");function T(i,e,n){return"("+i+") ? ("+e+") : ("+n+")"}O.push(d(0,"x","this.points",R)),j&&O.push(d(0,"w","this.weights",D)),q||O.push(d(0,"k","this.knots",E));var X=[];for(A=0;A<w;A++)switch(t(E)){case t.NDARRAY:X[A]=!0;break;case t.ARRAY_OF_ARRAYS:X[A]=n(E[A])}for(A=0;A<w;A++)if(X[A])for(J("\n  // Bisect to locate the knot interval in dimension "+A+"\n"),H("var "+W(A)+" = 0;"),H("h = "+V(A)+";"),H("while(h > "+W(A)+" + 1) {"),H("  m = 0.5 * (h + "+W(A)+") | 0;"),H("  if ("+P([A,"m"])+" > "+M(A)+") h = m;"),H("  else "+W(A)+" = m;"),H("}"),J("\n  // Fetch knots for dimension "+A+"\n"),v=1-k[A];v<=k[A];v++)"closed"===z[A]?H(v<0?"var "+C([A,v+k[A]-1])+" = "+T(W(A)+" < "+-v,P([A,0])+" + "+P([A,[V(A),W(A),v]])+" - "+P([A,[V(A)]]),P([A,[W(A),v]]))+";":v>0?"var "+C([A,v+k[A]-1])+" = "+T(W(A)+" + "+v+" > "+V(A),P([A,V(A)])+" + "+P([A,v+" + "+W(A)+" - "+V(A)])+" - "+P([A,0]),P([A,[W(A),v]]))+";":"var "+C([A,v+k[A]-1])+" = "+P([A,[W(A),v]])+";"):H("var "+C([A,v+k[A]-1])+" = "+P([A,[W(A),v]])+";");else{for(J("\n  // Directly compute knot interval for dimension "+A+"\n"),"closed"===z[A]?H(W(A)+" = ("+M(A)+" | 0) % "+V(A)+";"):(H(W(A)+" = ("+M(A)+" | 0);"),H("if ("+W(A)+" < "+k[A]+") "+W(A)+" = "+k[A]+";"),H("if ("+W(A)+" > "+V(A)+" - 1) "+W(A)+" = "+V(A)+" - 1;")),J("\n  // Compute and clamp knots for dimension "+A+"\n"),v=1-k[A];v<=k[A];v++)H("var "+(y=C([A,v+k[A]-1]))+" = "+W(A)+" + "+v+";");if("clamped"===z[A])for(v=1-k[A];v<=k[A];v++)y=C([A,v+k[A]-1]),v<0&&H("if ("+y+" < "+k[A]+") "+y+" = "+k[A]+";"),v>0&&H("if ("+y+" > "+V(A)+") "+y+" = "+V(A)+";");"closed"===z[A]&&(J("\n  // Wrap the B-Spline parameter for closed boundary"),H(M(A)+" %= "+V(A)+";"))}for(A=0,m=[];A<w;A++)m[A]=k[A]+1;for(j&&(J("\n  // Fetch weights\n"),f(m,(function(i){for(var e=[],n=[],t=0;t<w;t++)e[t]=[W(t),i[t]-k[t]],"closed"===z[t]&&i[t]-k[t]<0&&(n[t]=V(t));H("var "+G(i)+" = "+F(e,n)+";")}))),o&&H(j?"\n  // Fetch points and project into homogeneous (weighted) coordinates\n":"\n  // Fetch points\n"),f(m,(function(i){for(var e=[],n=[],t=0;t<w;t++)e[t]=[W(t),i[t]-k[t]],"closed"===z[t]&&i[t]-k[t]<0&&(n[t]=V(t));if(h)H(j?"var "+K(i)+" = "+S(e,n)+" * "+G(i)+";":"var "+K(i)+" = "+S(e,n)+";");else for(t=0;t<_;t++){var r=i.concat(t);e[w]=t,H(j?"var "+K(r)+" = "+S(e,n)+" * "+G(i)+";":"var "+K(r)+" = "+S(e,n)+";")}})),J("\n"),J("// Perform De Boor's algorithm"),A=m.length-1;A>=0;A--)for(m[A]=[k[A],k[A]+1],v=0;v<k[A];v++)for(J("\n  // Degree "+k[A]+" evaluation in dimension "+A+", step "+(v+1)+"\n"),g=k[A];g>v;g--){var Z=u&&k[A]-v-u[A]<=0;Z?(H("m = 1 / ("+C([A,g-v+k[A]-1])+" - "+C([A,g-1])+");"),j&&(H("a = ("+M(A)+" - "+C([A,g-1])+") * m;"),H("b = 1 - a;"))):(H("a = ("+M(A)+" - "+C([A,g-1])+") / ("+C([A,g-v+k[A]-1])+" - "+C([A,g-1])+");"),H("b = 1 - a;")),j&&f(m,(function(i){var e=i.slice(),n=i.slice();e[A]=g,n[A]=g-1,Z&&j&&H("h = "+G(e)+";"),H(G(e)+" = b * "+G(n)+" + a * "+G(e)+";")})),f(m,(function(i){var e,n,t,r=i.slice(),s=i.slice();if(r[A]=g,s[A]=g-1,Z){var o=v+1;if(h)e=j?"h * "+G(s)+" / "+G(r)+" * ":"",n=K(r)+(j?" / h":""),t=K(s)+(j?" / "+G(s):""),H(K(r)+" = "+o+" * "+e+"("+n+" - "+t+") * m;");else{var a=r.slice(),u=s.slice();for(b=0;b<_;b++)a[w]=u[w]=b,e=j?"h * "+G(s)+" / "+G(r)+" * ":"",n=K(a)+(j?" / h":""),t=K(u)+(j?" / "+G(s):""),H(K(a)+" = "+o+" * "+e+"("+n+" - "+t+") * m;")}}else if(h)H(K(r)+" = b * "+K(s)+" + a * "+K(r)+";");else for(b=0;b<_;b++)r[w]=s[w]=b,H(K(r)+" = b * "+K(s)+" + a * "+K(r)+";")})),J("\n")}if(o&&H(j?"\n  // Project back from homogeneous coordinates and return final output\n":"\n  // Return final output\n"),h)H(j?"return "+K(k)+" / "+G(k)+";":"return "+K(k)+";");else for(A=0;A<_;A++)H(j?"out["+A+"] = "+K(k.concat([A]))+" / "+G(k)+";":"out["+A+"] = "+K(k.concat([A]))+";");if(h||H("return out;"),O.push("}"),o){var $=O.join("\n");x($),p[i]=$}var ii=new Function([O.join("\n"),"; return ",B].join(""))();return l[i]=ii,ii.bind(e)}var g={};var m={};var b={open:"open",closed:"closed",clamped:"clamped"};function A(i){return null==i}function y(e,s,a,h,l,p){var y,w;!e||n(e)||i(e)?(p=p||{},this.weights=h,this.knots=a,this.degree=s,this.points=e,this.boundary=l,this.debug=p.debug,this.checkBounds=!!p.checkBounds,Object.defineProperty(this,"size",{value:p.size,writable:!0,configurable:!0})):(p=e,this.debug=e.debug,this.checkBounds=!!e.checkBounds,this.weights=e.weights,this.knots=e.knots,this.degree=e.degree,this.boundary=e.boundary,this.points=e.points,Object.defineProperty(this,"size",{value:p.size,writable:!0,configurable:!0}));var R=t(this.points),k=t(this.weights),D=t(this.knots);if(this.points)switch(R){case t.GENERIC_NDARRAY:case t.NDARRAY:Object.defineProperties(this,{splineDimension:{value:this.points.shape.length-1,writable:!1,configurable:!0},dimension:{value:this.points.shape[this.points.shape.length-1],writable:!1,configurable:!0},size:{get:function(){return this.points.shape.slice(0,this.points.shape.length-1)},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case t.ARRAY_OF_ARRAYS:var j=0,E=this.size||[];E.length=0;for(var _=this.points;n(_[0]);_=_[0])j++,E.push(_.length);if(0===j)throw new Error("Expected an array of points");Object.defineProperties(this,{splineDimension:{value:j,writable:!1,configurable:!0},dimension:{value:_.length,writable:!1,configurable:!0},size:{get:function(){var i=[];i.length=0;for(var e=0,n=this.points;e<this.splineDimension;e++,n=n[0])i[e]=n.length;return i},set:function(){throw new Error("Cannot assign to read only property 'size'")},configurable:!0}});break;case t.PACKED:default:throw new Error("Expected either a packed array, array of arrays, or ndarray of points")}else{if(void 0===this.size||null===this.size)throw new Error("Either points or a control hull size must be provided.");if(n(this.size)||Object.defineProperty(this,"size",{value:[this.size],writable:!0,configurable:!0}),0===this.size.length)throw new Error("`size` must be a number or an array of length at least one.");Object.defineProperties(this,{splineDimension:{value:this.size.length,writable:!1,configurable:!0},dimension:{value:0,writable:!1,configurable:!0}})}if(n(this.degree)){for(y=0;y<this.splineDimension;y++)if(A(this.degree[y]))throw new Error("Missing degree in dimension "+(y+1))}else{var z=!A(this.degree),Y=A(this.degree)?2:this.degree;for(this.degree=[],y=0;y<this.splineDimension;y++)if(this.size[y]<=Y){if(z)throw new Error("Expected at least "+(Y+1)+" points for degree "+Y+" spline in dimension "+(y+1)+" but got only "+this.size[y]);this.degree[y]=this.size[y]-1}else this.degree[y]=Y}if(w="string"!=typeof this.boundary?"open":this.boundary,!b[w])throw new Error("Boundary type must be one of "+Object.keys(b)+". Got "+w);for(this.boundary=n(this.boundary)?this.boundary:[],this.boundary.length=this.splineDimension,y=0;y<this.splineDimension;y++)if(this.boundary[y]=A(this.boundary[y])?w:this.boundary[y],!b[w])throw new Error("Boundary type must be one of "+Object.keys(b)+". Got "+w+" for dimension "+(y+1));switch(D){case t.ARRAY_OF_ARRAYS:for(n(this.knots)&&this.knots.length>0&&!n(this.knots[0])&&(this.knots=[this.knots]),y=0;y<this.splineDimension;y++){if(this.size[y]<=this.degree[y])throw new Error("Expected at least "+(this.degree[y]+1)+" points in dimension "+(y+1)+" but got "+this.size[y]+".");if(n(this.knots[y])){if("closed"!==this.boundary[y]&&this.knots[y].length!==this.degree[y]+this.size[y]+1)throw new Error("Expected "+(this.degree[y]+this.size[y]+1)+" knots in dimension "+(y+1)+" but got "+this.knots[y].length+".");if("closed"===this.boundary[y]&&this.knots[y].length!==this.size[y]+1&&!(this.knots[y].length===this.size[y]+this.degree[y]+1))throw new Error("Expected "+(this.size[y]+1)+" knots for closed spline in dimension "+(y+1)+" but got "+this.knots[y].length+".")}}}var N=function(i,e,t,r,s,o){var a,h,u=[],f=!1;for(a=0;a<i.splineDimension;a++){var d=n(i.knots)&&n(i.knots[a]);d&&(f=!0),u.push("Deg"+i.degree[a]+(d?"":"Uniform")+((h=i.boundary[a])[0].toUpperCase()+h.slice(1)))}var c=[[f?"NU":"",i.weights?"RBS":"BS"].join("")+i.dimension+"D",u.join("_")];return r&&c.push(r+"Pts"),s&&c.push(s+"Wts"),o&&c.push(o+"Kts"),e&&c.push("debug"),t&&c.push("chk"),c.join("_")}(this,this.debug,this.checkBounds,R,k,D);if(N!==this.__cacheKey){this.__cacheKey=N;var x=function(i){var e,n={};return(e=o("x",i.points))&&(n.point=e),(e=o("w",i.weights))&&(n.weight=e),(e=o("k",i.knots))&&(n.knot=e),n}(this);this.evaluate=v(this.__cacheKey,this,x,this.debug,this.checkBounds,!1),this.transform=function(i,e,n,t){var s,o,a,h,u,f,l,p,v=g[i];if(v)return v.bind(e);var m=[],b="transform"+i;m.push("function "+b+"(m) {"),m.push("var i, w;"),m.push(d(0,"x","this.points",e.points));var A=r(t?"size":"s");for(s=0;s<e.splineDimension;s++)m.push("var "+A(s)+" = "+c(e.points,"this.points",s)+";");for(h=[],s=0;s<e.splineDimension;s++)a="i"+s,h.push(a),m.push("for ("+a+" = "+A(s)+"- 1; "+a+" >= 0; "+a+"--) {");for(s=0;s<e.dimension;s++)m.push("x"+s+" = "+n.point(h.concat([s])));for(u=[],s=0;s<e.dimension;s++)u.push("m["+((e.dimension+1)*(s+1)-1)+"] * x"+s);for(u.push("m["+((e.dimension+1)*(e.dimension+1)-1)+"]"),m.push("var w = ("+u.join(" + ")+") || 1.0;"),s=0;s<e.dimension;s++){for(u=[],f=e.dimension,o=0;o<f;o++)u.push("m["+(o*(f+1)+s)+"] * x"+o);u.push("m["+(o*(f+1)+s)+"]"),p=n.point(h.concat([s])),l="("+u.join(" + ")+") / w",m.push(p+" = "+l+";")}for(s=e.splineDimension-1;s>=0;s--)m.push("}");m.push("return this;"),m.push("}");var y=new Function([m.join("\n"),"; return ",b].join(""))();return t&&console.log(m.join("\n")),g[i]=y,y.bind(e)}(this.__cacheKey,this,x,this.debug),this.support=function(i,e,s,o,a){var h=m[i];if(h)return h.bind(e);var u,l,p,v=e.degree,g=e.knots,b=e.splineDimension,A=e.boundary,y=[],w="support"+i,R=s.knot,k=r("t"),D=o?"domain":"d",j=r(o?"size":"s"),E=r(o?"knotIndex":"i"),_=!0;for(p=0;p<b;p++)n(g)&&n(g[p])&&(_=!1);function z(i){y.push("  "+(i||""))}var Y=[];for(u=0;u<b;u++)Y.push(k([u]));y.push("function "+w+" (out, "+Y.join(", ")+") {");var N=0;function x(i,e){z(void 0===e?"out["+N+++"] = "+i.join(" + ")+";":"out["+N+++"] = ("+i.join(" + ")+" + "+e+") % "+e+";")}for(z("var h, m;"),z("var c = 0;"),a&&(z("var "+D+" = this.domain;"),z("for (var i = 0; i < this.splineDimension; i++) {"),z("  a = arguments[i + 1];"),z("  if (a < "+D+"[i][0] || a > "+D+"[i][1] || a === undefined || isNaN(a)) {"),z("    throw new Error('Invalid Spline parameter in dimension '+i+'. Valid domain is ['+"+D+"[i][0]+', '+"+D+"[i][1]+']. but got t'+i+' = '+arguments[i + 1]+'.');"),z("  }"),z("}")),p=0;p<b;p++)z("var "+j(p)+" = "+c(e.points,"this.points",p)+";");_||y.push(d(0,"k","this.knots",g));var O=[];for(p=0;p<b;p++)switch(t(g)){case t.NDARRAY:O[p]=!0;break;case t.ARRAY_OF_ARRAYS:O[p]=n(g[p])}for(p=0;p<b;p++)O[p]?(z("var "+E(p)+" = 0;"),z("h = "+j(p)+";"),z("while(h > "+E(p)+" + 1) {"),z("  m = 0.5 * (h + "+E(p)+") | 0;"),z("  if ("+R([p,"m"])+" > "+k(p)+") h = m;"),z("  else "+E(p)+" = m;"),z("}")):"closed"===A[p]?z(E(p)+" = ("+k(p)+" | 0) % "+j(p)+";"):(z(E(p)+" = ("+k(p)+" | 0);"),z("if ("+E(p)+" < "+v[p]+") "+E(p)+" = "+v[p]+";"),z("if ("+E(p)+" > "+j(p)+" - 1) "+E(p)+" = "+j(p)+" - 1;"));for(p=0,l=[];p<b;p++)l[p]=v[p]+1;f(l,(function(i){for(var e=[],n=[],t=0;t<b;t++)e[t]=[E(t),i[t]-v[t]],"closed"===A[t]&&i[t]-v[t]<0&&(n[t]=j(t));for(t=0;t<b;t++)x(e[t],n[t])})),z("out.length = "+N+";"),z("return out;"),y.push("}"),o&&console.log(y.join("\n"));var B=new Function([y.join("\n"),"; return ",w].join(""))();return m[i]=B,B.bind(e)}(this.__cacheKey,this,x,this.debug,this.checkBounds),this.evaluator=function(i,e){return v(this.__cacheKey,this,x,this.debug,this.checkBounds,e,i)}}return this.numericalDerivative=u.bind(this),this}function w(){var i,n=[],t=this.points;t?e(t)&&(i=t.shape):i=this.size;for(var r=0;r<this.splineDimension;r++){var s=i?i[r]:t.length,o=this.degree[r],a="closed"===this.boundary[r];if(this.knots&&this.knots[r]){var h=this.knots[r];n[r]=[h[a?0:o],h[s]]}else n[r]=[a?0:o,s];t&&(t=t[0])}return n}function R(i,e,n,t,r,s){var o=function(i,e,n,t,r,s){return a(i,e,n,t,r,s),o},a=y.bind(o);return Object.defineProperty(o,"domain",{get:w}),a(i,e,n,t,r,s),o}export default R;
